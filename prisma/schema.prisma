generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String             @id @default(uuid())
  firstName                String
  lastName                 String
  email                    String             @unique
  phone                    String?
  password                 String
  status                   UserStatus         @default(ACTIVE)
  accountType              AccountType        @default(USER)
  createdAt                DateTime           @default(now())
  stripeCustomerId         String?            @unique
  referredById             String?
  stripeSubscriptionId     String?            @unique
  subscriptionStatus       SubscriptionStatus @default(INCOMPLETE)
  currentPeriodEnd         DateTime?
  installmentsPaid         Int                @default(0)
  installmentsRequired     Int                @default(1)
  availableCourseDiscounts Int                @default(0)
  otpCode                  String?
  otpExpiresAt             DateTime?
  resetPasswordExpires     DateTime?
  resetPasswordToken       String?            @unique
  coursePurchases          CoursePurchase[]
  notifications            Notification[]
  searchHistory            SearchHistory[]
  transactions             Transaction[]
  favorites                UserFavorite[]
  referrer                 User?              @relation("Referrals", fields: [referredById], references: [id])
  referrals                User[]             @relation("Referrals")
  videoProgress            VideoProgress[]
  visitedProfiles          VisitedProfile[]
  hotmartTransactionCode   String?            @unique
  tickets                  Ticket[]
  seenSections             UserSeenSection[]  
  seenCourses              UserSeenCourse[]
  hasSeenWelcomeModal      Boolean            @default(false)

  @@index([referredById], map: "users_referredById_fkey")
  @@map("users")
}

model Transaction {
  id                   String    @id @default(uuid())
  amount               Float
  currency             String
  status               String
  createdAt            DateTime  @default(now())
  userId               String
  stripeSubscriptionId String?  
  stripePaymentId      String? 
  stripePriceId        String?
  stripeInvoiceId      String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean?  @default(false)
  user                 User      @relation(fields: [userId], references: [id])
  closer               String?
  hotmartTransactionCode String?
  @@index([userId], map: "transactions_userId_fkey")
  @@map("transactions")
}

model ContentCreator {
  id          String           @id @default(uuid())
  profileLink String
  nickname    String?
  username    String
  country     String
  email       String?
  instagram   String?
  youtube     String?
  followers   Int              @default(0)
  posts       Int              @default(0)
  likes       Int              @default(0)
  bio         String?          @db.Text
  regionId    String
  nicheId     String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  niche       Niche?           @relation(fields: [nicheId], references: [id])
  region      Region           @relation(fields: [regionId], references: [id])
  visitedBy   VisitedProfile[]

  @@index([nicheId], map: "content_creators_nicheId_fkey")
  @@index([regionId], map: "content_creators_regionId_fkey")
  @@map("content_creators")
}

model Region {
  id              String           @id @default(uuid())
  name            String           @unique
  countryName     String?
  flag            String?
  contentCreators ContentCreator[]

  @@map("regions")
}

model Niche {
  id              String           @id @default(uuid())
  name            String           @unique
  contentCreators ContentCreator[]

  @@map("niches")
}

model Notification {
  id        String   @id @default(uuid())
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "notifications_userId_fkey")
  @@map("notifications")
}

model SearchHistory {
  id        String   @id @default(uuid())
  keyword   String?
  country   String?
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId], map: "search_history_userId_fkey")
  @@map("search_history")
}

model VisitedProfile {
  id        String         @id @default(uuid())
  visitedAt DateTime       @default(now())
  userId    String
  creatorId String
  creator   ContentCreator @relation(fields: [creatorId], references: [id])
  user      User           @relation(fields: [userId], references: [id])

  @@index([creatorId], map: "visited_profiles_creatorId_fkey")
  @@index([userId], map: "visited_profiles_userId_fkey")
  @@map("visited_profiles")
}

model MigratedFiles {
  id         String   @id @default(uuid())
  fileName   String
  filePath   String
  migratedAt DateTime @default(now())

  @@map("migrated_files")
}

model VideoCourse {
  id               String           @id @default(uuid())
  title            String
  description      String?          @db.Text
  order            Int              @default(0)
  coverImageUrl    String?
  priceEur         Float?           @default(0)
  priceUsd         Float?           @default(0)
  priceAed         Float?           @default(0)
  stripePriceIdEur String?          @unique
  stripePriceIdUsd String?          @unique
  stripePriceIdAed String?          @unique
  language         Language         @default(EN)
  createdAt        DateTime         @default(now())
  purchasedBy      CoursePurchase[]
  sections         Section[]
  seenBy      UserSeenCourse[] 

  @@map("video_courses")
}

model UserSeenCourse {
  id        String      @id @default(uuid())
  userId    String
  courseId  String
  seenAt    DateTime    @default(now())

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    VideoCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId], map: "user_seen_courses_courseId_fkey")
  @@map("user_seen_courses")
}

model CoursePurchase {
  id            String      @id @default(uuid())
  purchasePrice Float
  purchasedAt   DateTime    @default(now())
  userId        String
  courseId      String
  course        VideoCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId], map: "course_purchases_courseId_fkey")
  @@map("course_purchases")
}

model Video {
  id          String          @id @default(uuid())
  title       String
  description String?         @db.Text
  vimeoId     String          @db.Text
  duration    Int?
  order       Int             @default(0)
  sectionId   String
  progress    VideoProgress[]
  section     Section         @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  createdAt   DateTime        @default(now())

  @@index([sectionId], map: "videos_sectionId_fkey")
  @@map("videos")
}

model Section {
  id       String      @id @default(uuid())
  title    String
  order    Int         @default(0)
  courseId String
  course   VideoCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  videos   Video[]
  createdAt DateTime    @default(now())
  seenBy    UserSeenSection[]
  @@index([courseId], map: "course_sections_courseId_fkey")
  @@map("course_sections")
  
}

model UserSeenSection {
  id        String   @id @default(uuid())
  userId    String
  sectionId String
  seenAt    DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([userId, sectionId])
  @@index([sectionId], map: "user_seen_sections_sectionId_fkey")
  @@map("user_seen_sections")
}

model VideoProgress {
  id           String    @id @default(uuid())
  userId       String
  videoId      String
  completed    Boolean   @default(false)
  completedAt  DateTime?
  
  lastPosition Float     @default(0) // Timestamp in seconds where they left off
  percentage   Int       @default(0) // 0-100 percent watched
  
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  video        Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([videoId], map: "video_progress_videoId_fkey")
  @@map("video_progress")
}

model WinningProduct {
  id                     String         @id @default(uuid())
  productId              BigInt         @unique
  title                  String?        @db.Text
  productUrl             String?        @db.Text
  imageUrl               String?        @db.Text
  price                  Float?
  currency               String?        @default("USD")
  salesVolume            Int?
  categoryName           String?
  firstLevelCategoryName String?
  historicalData         Json?
  googleTrendKeyword     String?
  source                 String         @default("RapidAPI/AliExpress")
  importedAt             DateTime       @default(now())
  shopName               String?
  shopEvaluationRate     String?
  shopUrl                String?        @db.Text
  shopId                 BigInt?
  favoritedBy            UserFavorite[]

  @@map("winning_products")
}

model UserFavorite {
  id        String         @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime       @default(now())
  product   WinningProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId], map: "user_favorites_productId_fkey")
  @@map("user_favorites")
}

model Setting {
  key   String @id @unique
  value String

  @@map("settings")
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  LIFETIME_ACCESS
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AccountType {
  USER
  ADMIN
}

enum Language {
  FR
  EN
  AR
}


// --- SUPPORT TICKET SYSTEM ---

model Ticket {
  id          String         @id @default(uuid())
  subject     String         @db.Text
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    String         @default("GENERAL") // GENERAL, BILLING, TECHNICAL, PARTNERSHIP

  // Authenticated User Link (Optional)
  userId      String?
  user        User?          @relation(fields: [userId], references: [id])

  // Guest User Info (Used if userId is null)
  guestName   String?
  guestEmail  String?
  
  // Security for Guests (Magic Link Access)
  accessToken String         @default(uuid()) @unique 

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  messages    TicketMessage[]

  @@index([userId])
  @@index([status])
  @@index([accessToken])
  @@map("tickets")
}

model TicketMessage {
  id         String     @id @default(uuid())
  content    String     @db.Text
  isInternal Boolean    @default(false) // If true, only Admins see this (Private Note)
  
  senderType SenderType @default(USER)
  senderId   String?    // ID of the User/Admin. Null if Guest.

  ticketId   String
  ticket     Ticket     @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  createdAt  DateTime   @default(now())

  @@index([ticketId])
  @@map("ticket_messages")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SenderType {
  USER
  ADMIN
  GUEST
  SYSTEM
}
